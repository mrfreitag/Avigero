<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.mozilla.org/bugzilla.dtd">

<bugzilla version="3.6.4+"
          urlbase="https://bugzilla.mozilla.org/"
          
          maintainer="bugzilla-admin@mozilla.org"
>

    <bug>
          <bug_id>648434</bug_id>
          
          <creation_ts>2011-04-07 17:20:00 -0700</creation_ts>
          <short_desc>context-menu should create workers only when needed</short_desc>
          <delta_ts>2011-04-11 17:59:27 -0700</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Client Software</classification>
          <product>Add-on SDK</product>
          <component>General</component>
          <version>unspecified</version>
          <rep_platform>All</rep_platform>
          <op_sys>All</op_sys>
          <bug_status>RESOLVED</bug_status>
          <resolution>FIXED</resolution>
          
          
          
          
          
          <priority>--</priority>
          <bug_severity>normal</bug_severity>
          <target_milestone>1.0b5</target_milestone>
          
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Drew Willcoxon :adw">adw</reporter>
          <assigned_to name="Drew Willcoxon :adw">adw</assigned_to>
          
          <qa_contact>general</qa_contact>
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          

      

      

      

          <long_desc isprivate="0">
            <commentid>5395536</commentid>
              <attachid>524546</attachid>
            <who name="Drew Willcoxon :adw">adw</who>
            <bug_when>2011-04-07 17:20:13 -0700</bug_when>
            <thetext>Created attachment 524546
patch

Spun out from bug 642004 comment 0 and 1.

context-menu should lazily create content workers: if a menu item has a URL context that doesn&apos;t match a page, then a worker shouldn&apos;t be created for that item-window pair.  If that URL context is later removed, the worker should then be created.

Likewise, if a URL context is added to an item, then any workers for pages that don&apos;t match that context should be destroyed.

That&apos;s what this patch does.

It also makes one other change, which is to simplify the worker registry by using Irakli&apos;s trick of keeping &quot;private&quot; versions of items that are accessed through a key (bug 578849, thanks Irakli!).  That way, a singleton registry with its complex worker matrix isn&apos;t needed: I just store windows/workers in private versions of items.  The first change builds on this change, but if you&apos;d prefer a separate patch for it, let me know.</thetext>
          </long_desc>
          <long_desc isprivate="0">
            <commentid>5400373</commentid>
            <who name="Drew Willcoxon :adw">adw</who>
            <bug_when>2011-04-11 08:09:21 -0700</bug_when>
            <thetext>(In reply to comment #0)
&gt; It also makes one other change, which is to simplify the worker registry by
&gt; using Irakli&apos;s trick of keeping &quot;private&quot; versions of items that are accessed
&gt; through a key (bug 578849, thanks Irakli!).

Bug 598982 I meant.</thetext>
          </long_desc>
          <long_desc isprivate="0">
            <commentid>5402184</commentid>
              <attachid>524546</attachid>
            <who name="Myk Melez [:myk]">myk</who>
            <bug_when>2011-04-11 16:52:14 -0700</bug_when>
            <thetext>Comment on attachment 524546
patch

Brain transplants all around!</thetext>
          </long_desc>
          <long_desc isprivate="0">
            <commentid>5402433</commentid>
            <who name="Drew Willcoxon :adw">adw</who>
            <bug_when>2011-04-11 17:59:27 -0700</bug_when>
            <thetext>https://github.com/mozilla/addon-sdk/commit/06bcc6602e1e4c84c3a375a94dc5f3fcc545adb9</thetext>
          </long_desc>
      
          <attachment
              isobsolete="0"
              ispatch="1"
              isprivate="0"
              isurl="0"
          >
            <attachid>524546</attachid>
            <date>2011-04-07 17:20:00 -0700</date>
            <delta_ts>2011-04-11 16:52:14 -0700</delta_ts>
            <desc>patch</desc>
            <filename>patch.diff</filename>
            <type>text/plain</type>
            <size>29352</size>
            <attacher>adw</attacher>
            
              <data encoding="base64">ZGlmZiAtLWdpdCBhL3BhY2thZ2VzL2FkZG9uLWtpdC9saWIvY29udGV4dC1tZW51LmpzIGIvcGFj
a2FnZXMvYWRkb24ta2l0L2xpYi9jb250ZXh0LW1lbnUuanMKaW5kZXggYTQ1MmU0Zi4uZTE2YzQz
MCAxMDA2NDQKLS0tIGEvcGFja2FnZXMvYWRkb24ta2l0L2xpYi9jb250ZXh0LW1lbnUuanMKKysr
IGIvcGFja2FnZXMvYWRkb24ta2l0L2xpYi9jb250ZXh0LW1lbnUuanMKQEAgLTEwMywxOSArMTAz
LDIxIEBAIGNvbnN0IE5PTl9QQUdFX0NPTlRFWFRfRUxUUyA9IFsKICAgQ2kubnNJRE9NSFRNTE1l
ZGlhRWxlbWVudCwKICAgQ2kubnNJRE9NSFRNTE1lbnVFbGVtZW50LAogICBDaS5uc0lET01IVE1M
T2JqZWN0RWxlbWVudCwKICAgQ2kubnNJRE9NSFRNTE9wdGlvbkVsZW1lbnQsCiAgIENpLm5zSURP
TUhUTUxTZWxlY3RFbGVtZW50LAogICBDaS5uc0lET01IVE1MVGV4dEFyZWFFbGVtZW50LAogXTsK
IAotLy8gVGhpcyBvYmplY3QgaXMgdXNlZCBlbHNld2hlcmUgaW4gdGhpcyBmaWxlIHRvIGFjY2Vz
cyBwcml2YXRlIHZlcnNpb25zIG9mCi0vLyBgSXRlbWAgYW5kIGBNZW51YCBpbnN0YW5jZXMuCi1j
b25zdCBQUklWQVRFID0geyB2YWx1ZU9mOiBmdW5jdGlvbiB2YWx1ZU9mKCkgJ3ByaXZhdGVzIGFj
Y2Vzc29yJyB9CisvLyBUaGlzIG9iamVjdCBpcyB1c2VkIGVsc2V3aGVyZSBpbiB0aGlzIGZpbGUg
dG8gYWNjZXNzIHByaXZhdGUgcHJvcGVydGllcyBvZgorLy8gSXRlbSBhbmQgTWVudSBpbnN0YW5j
ZXMuCitjb25zdCBQUklWQVRFX1BST1BTX0tFWSA9IHsKKyAgdmFsdWVPZjogZnVuY3Rpb24gdmFs
dWVPZigpICJwcml2YXRlIHByb3BlcnRpZXMga2V5IgorfTsKIAogZXhwb3J0cy5JdGVtID0gYXBp
VXRpbHMucHVibGljQ29uc3RydWN0b3IoSXRlbSk7CiBleHBvcnRzLk1lbnUgPSBhcGlVdGlscy5w
dWJsaWNDb25zdHJ1Y3RvcihNZW51KTsKIGV4cG9ydHMuU2VwYXJhdG9yID0gYXBpVXRpbHMucHVi
bGljQ29uc3RydWN0b3IoU2VwYXJhdG9yKTsKIAogCiBmdW5jdGlvbiBJdGVtKG9wdGlvbnMpIHsK
ICAgbGV0IHJ1bGVzID0gb3B0aW9uc1J1bGVzKCk7CkBAIC0yNDEsMTggKzI0MywyMyBAQCBmdW5j
dGlvbiBVUkxDb250ZXh0KHBhdHRlcm5zKSB7CiAgIHRyeSB7CiAgICAgcGF0dGVybnMgPSBvcHRz
LnBhdHRlcm5zLm1hcChmdW5jdGlvbiAocCkgbmV3IE1hdGNoUGF0dGVybihwKSk7CiAgIH0KICAg
Y2F0Y2ggKGVycikgewogICAgIGNvbnNvbGUuZXJyb3IoIkVycm9yIGNyZWF0aW5nIFVSTENvbnRl
eHQgbWF0Y2ggcGF0dGVybjoiKTsKICAgICB0aHJvdyBlcnI7CiAgIH0KIAorICBjb25zdCBzZWxm
ID0gdGhpczsKKwogICB0aGlzLmlzQ3VycmVudCA9IGZ1bmN0aW9uIFVSTENvbnRleHRfaXNDdXJy
ZW50KHBvcHVwTm9kZSkgewotICAgIGxldCB1cmwgPSBwb3B1cE5vZGUub3duZXJEb2N1bWVudC5V
Ukw7CisgICAgcmV0dXJuIHNlbGYuaXNDdXJyZW50Rm9yVVJMKHBvcHVwTm9kZS5vd25lckRvY3Vt
ZW50LlVSTCk7CisgIH07CisKKyAgdGhpcy5pc0N1cnJlbnRGb3JVUkwgPSBmdW5jdGlvbiBVUkxD
b250ZXh0X2lzQ3VycmVudEZvclVSTCh1cmwpIHsKICAgICByZXR1cm4gcGF0dGVybnMuc29tZShm
dW5jdGlvbiAocCkgcC50ZXN0KHVybCkpOwogICB9OwogfQogCiBVUkxDb250ZXh0LnByb3RvdHlw
ZSA9IG5ldyBDb250ZXh0KCk7CiAKIGV4cG9ydHMuUGFnZUNvbnRleHQgPSBhcGlVdGlscy5wdWJs
aWNDb25zdHJ1Y3RvcihQYWdlQ29udGV4dCk7CiBleHBvcnRzLlNlbGVjdG9yQ29udGV4dCA9IGFw
aVV0aWxzLnB1YmxpY0NvbnN0cnVjdG9yKFNlbGVjdG9yQ29udGV4dCk7CkBAIC0zMTAsNTkgKzMx
Nyw4NSBAQCBmdW5jdGlvbiBvcHRpb25zUnVsZXMoKSB7CiAgIH07CiB9CiAKIC8vIERlZmluZXMg
c29tZSBnZXR0ZXJzIGFuZCBvdGhlciBwcm9wZXJ0aWVzIHRoYXQgYXJlIGNvbW1vbiB0byBJdGVt
IGFuZCBNZW51LgogLy8gaXRlbSBpcyB0aGUgSXRlbSBvciBNZW51IG9iamVjdCBvbiB3aGljaCB0
byBkZWZpbmUgdGhlIHByb3BlcnRpZXMsIGFuZAogLy8gb3B0aW9ucyBpcyBhIHZhbGlkYXRlZCBv
cHRpb25zIG9iamVjdC4KIGZ1bmN0aW9uIGRlZmluZUl0ZW1Qcm9wcyhpdGVtLCBvcHRpb25zKSB7
CiAgIC8vIFRPRE86IEFkZCBzZXR0ZXIgZm9yIGxhYmVsPyAgSXQgd291bGQgcmVxdWlyZSBmaW5k
aW5nIHRoZSBpdGVtJ3MgRE9NCi0gIC8vIGVsZW1lbnQgYW5kIGNoYW5naW5nIGl0cyBhdHRyaWJ1
dGVzIGFzIHdlbGwuICBOb3RlIGhvd2V2ZXIgdGhhdAotICAvLyBXb3JrZXJSZWdpc3RyeSByZWxp
ZXMgb24gbGFiZWwgcmVtYWluaW5nIGNvbnN0YW50LCBzbyBpZiBzZXR0ZXJzIGFyZSBhZGRlZCwK
LSAgLy8gdGhhdCB3b3VsZCBuZWVkIGZpeGluZy4KKyAgLy8gZWxlbWVudCBhbmQgY2hhbmdpbmcg
aXRzIGF0dHJpYnV0ZXMgYXMgd2VsbC4KICAgaXRlbS5fX2RlZmluZUdldHRlcl9fKCJsYWJlbCIs
IGZ1bmN0aW9uICgpIG9wdGlvbnMubGFiZWwpOwogCiAgIC8vIFN0dXBpZCB0ZXJuYXJpZXMgdG8g
YXZvaWQgU3BpZGVybW9ua2V5IHN0cmljdCB3YXJuaW5ncy4KICAgaXRlbS5fX2RlZmluZUdldHRl
cl9fKCJjb250ZW50U2NyaXB0IiwgZnVuY3Rpb24gKCkgewogICAgIHJldHVybiAiY29udGVudFNj
cmlwdCIgaW4gb3B0aW9ucyA/IG9wdGlvbnMuY29udGVudFNjcmlwdCA6IHVuZGVmaW5lZDsKICAg
fSk7CiAgIGl0ZW0uX19kZWZpbmVHZXR0ZXJfXygiY29udGVudFNjcmlwdEZpbGUiLCBmdW5jdGlv
biAoKSB7CiAgICAgcmV0dXJuICJjb250ZW50U2NyaXB0RmlsZSIgaW4gb3B0aW9ucyA/IG9wdGlv
bnMuY29udGVudFNjcmlwdEZpbGUgOgogICAgICAgICAgICB1bmRlZmluZWQ7CiAgIH0pOwogCi0g
IGNvbGxlY3Rpb24uYWRkQ29sbGVjdGlvblByb3BlcnR5KGl0ZW0sICJjb250ZXh0Iik7Ci0gIGlm
IChvcHRpb25zLmNvbnRleHQpCi0gICAgaXRlbS5jb250ZXh0LmFkZChvcHRpb25zLmNvbnRleHQp
OwotCiAgIGl0ZW0uZGVzdHJveSA9IGZ1bmN0aW9uIEl0ZW1fZGVzdHJveSgpIHsKICAgICBicm93
c2VyTWFuYWdlci5yZW1vdmVJdGVtKGl0ZW0pOwogICB9OwogCi0gIC8vIENyZWF0ZSBhIHByaXZh
dGUgdmVyc2lvbiBvZiB0aGUgYGl0ZW1gIHRoYXQgaXMgYW4gZXZlbnQgZW1pdHRlci4KLSAgbGV0
IHByaXZhdGVJdGVtID0gRXZlbnRFbWl0dGVyLmNyZWF0ZShpdGVtKTsKLSAgLy8gT3ZlcnJpZGUg
YE9iamVjdC5wcm90b3R5cGUudmFsdWVPZmAgdG8gbWFrZSB0aGUgcHJpdmF0ZSB2ZXJzaW9uIG9m
IHRoZQotICAvLyBpdGVtIGFjY2Vzc2libGUgdG8gYW55b25lIHdpdGggYWNjZXNzIHRvIHRoZSBg
UFJJVkFURWAgY29uc3RhbnQuIE9ubHkgdGhpcwotICAvLyBmaWxlIGhhcyBhY2Nlc3MgdG8gYFBS
SVZBVEVgLCBzbyBvbmx5IHRoaXMgZmlsZSBoYXMgYWNjZXNzIHRvIHRoZSBwcml2YXRlCi0gIC8v
IHZlcnNpb24uCi0gIGl0ZW0udmFsdWVPZiA9IGZ1bmN0aW9uIEl0ZW1fdmFsdWVPZih1bmxvY2tl
cikgewotICAgIHJldHVybiB1bmxvY2tlciA9PT0gUFJJVkFURSA/IHByaXZhdGVJdGVtIDogdGhp
czsKKyAgLy8gQ3JlYXRlIGEgcHJpdmF0ZSBwcm9wZXJ0aWVzIG9iamVjdCBmb3IgdGhlIGl0ZW0u
CisgIGxldCBwcml2YXRlUHJvcHMgPSB7CisgICAgZXZlbnRFbWl0dGVyOiBFdmVudEVtaXR0ZXIu
Y3JlYXRlKGl0ZW0pLAorICAgIHdvcmtlclJlZzogbmV3IFdvcmtlclJlZ2lzdHJ5KGl0ZW0pCisg
IH07CisKKyAgLy8gVGhpcyBtYWtlcyB0aGUgcHJpdmF0ZSBwcm9wZXJ0aWVzIGFjY2Vzc2libGUg
dG8gYW55b25lIHdpdGggYWNjZXNzIHRvIHRoZQorICAvLyBQUklWQVRFX1BST1BTX0tFWSBvYmpl
Y3QuICBPbmx5IHRoaXMgZmlsZSBoYXMgaGFzIGFjY2VzcyB0byBpdCwgc28gb25seQorICAvLyB0
aGlzIGZpbGUgaGFzIGFjY2VzcyB0byB0aGUgcHJpdmF0ZSBwcm9wZXJ0aWVzLgorICBpdGVtLnZh
bHVlT2YgPSBmdW5jdGlvbiBJdGVtX3ZhbHVlT2Yoa2V5KSB7CisgICAgcmV0dXJuIGtleSA9PT0g
UFJJVkFURV9QUk9QU19LRVkgPyBwcml2YXRlUHJvcHMgOiBpdGVtOwogICB9OwogCi0gIC8vIEFk
ZCBhbGwgb2YgYHByaXZhdGVJdGVtYCdzIG93biBwdWJsaWMgbWV0aG9kcyB0byB0aGUgaXRlbSBh
bmQgYmluZCB0aGVtIHRvCi0gIC8vIGBwcml2YXRlSXRlbWAuIFRoZXNlIGFyZSB0aGUgbWV0aG9k
cyBkZWZpbmVkIGJ5IHRoZSBgRXZlbnRFbWl0dGVyYCB0cmFpdC4KLSAgLy8gVGhpcyB3aWxsIGFs
bG93IGNsaWVudHMgdG8gdHJlYXQgdGhlIGl0ZW0gYXMgYW4gZXZlbnQgZW1pdHRlci4KLSAgT2Jq
ZWN0LmtleXMocHJpdmF0ZUl0ZW0pLmZvckVhY2goZnVuY3Rpb24gKGtleSkgeworICAvLyBBZGQg
YWxsIG9mIHByaXZhdGVQcm9wcy5ldmVudEVtaXR0ZXIncyBvd24gcHVibGljIG1ldGhvZHMgdG8g
dGhlIGl0ZW0sCisgIC8vIGJpbmRpbmcgdGhlbSB0byBldmVudEVtaXR0ZXIuICBUaGlzIHdpbGwg
YWxsb3cgY2xpZW50cyB0byB0cmVhdCB0aGUgaXRlbSBhcworICAvLyBhbiBldmVudCBlbWl0dGVy
LgorICBPYmplY3Qua2V5cyhwcml2YXRlUHJvcHMuZXZlbnRFbWl0dGVyKS5mb3JFYWNoKGZ1bmN0
aW9uIChrZXkpIHsKICAgICBpZiAoa2V5WzBdICE9PSAiXyIpCi0gICAgICBpdGVtW2tleV0gPSBw
cml2YXRlSXRlbVtrZXldLmJpbmQocHJpdmF0ZUl0ZW0pOworICAgICAgaXRlbVtrZXldID0KKyAg
ICAgICAgcHJpdmF0ZVByb3BzLmV2ZW50RW1pdHRlcltrZXldLmJpbmQocHJpdmF0ZVByb3BzLmV2
ZW50RW1pdHRlcik7CiAgIH0pOwogCiAgIC8vIFJlZ2lzdGVyIGEgbWVzc2FnZSBsaXN0ZW5lciBp
ZiBvbmUgd2FzIHBhc3NlZCB0byB0aGUgY29uc3RydWN0b3IuCiAgIGlmICgib25NZXNzYWdlIiBp
biBvcHRpb25zKQotICAgIHByaXZhdGVJdGVtLm9uKCJtZXNzYWdlIiwgb3B0aW9ucy5vbk1lc3Nh
Z2UpOworICAgIHByaXZhdGVQcm9wcy5ldmVudEVtaXR0ZXIub24oIm1lc3NhZ2UiLCBvcHRpb25z
Lm9uTWVzc2FnZSk7CisKKyAgLy8gV2hlbiBhIFVSTCBjb250ZXh0IGlzIHJlbW92ZWQgKGJ5IGNh
bGxpbmcgaXRlbS5jb250ZXh0LnJlbW92ZSh1cmxDb250ZXh0KSksCisgIC8vIHdlIG1heSBuZWVk
IHRvIGNyZWF0ZSB3b3JrZXJzIGZvciB3aW5kb3dzIGNvbnRhaW5pbmcgcGFnZXMgdGhhdCB0aGUg
aXRlbQorICAvLyBub3cgbWF0Y2hlcy4gIExpa2V3aXNlLCB3aGVuIGEgVVJMIGNvbnRleHQgaXMg
YWRkZWQsIHdlIG5lZWQgdG8gZGVzdHJveQorICAvLyB3b3JrZXJzIGZvciB3aW5kb3dzIGNvbnRh
aW5pbmcgcGFnZXMgdGhhdCB0aGUgaXRlbSBub3cgZG9lcyBub3QgbWF0Y2guCisgIC8vCisgIC8v
IGNvbGxlY3Rpb24gZG9lc24ndCBwcm92aWRlIGEgd2F5IHRvIGxpc3RlbiBmb3IgcmVtb3ZhbHMu
ICB1dGlscy9yZWdpc3RyeQorICAvLyBkb2VzLCBidXQgaXQgZG9lc24ndCBhbGxvdyBpdHMgZWxl
bWVudHMgdG8gYmUgZW51bWVyYXRlZC4gIFNvIGFzIGEgaGFjaywKKyAgLy8gdXNlIGEgY29sbGVj
dGlvbiBmb3IgaXRlbS5jb250ZXh0IGFuZCByZXBsYWNlIGl0cyBhZGQgYW5kIHJlbW92ZSBtZXRo
b2RzLgorICBjb2xsZWN0aW9uLmFkZENvbGxlY3Rpb25Qcm9wZXJ0eShpdGVtLCAiY29udGV4dCIp
OworICBpZiAob3B0aW9ucy5jb250ZXh0KQorICAgIGl0ZW0uY29udGV4dC5hZGQob3B0aW9ucy5j
b250ZXh0KTsKKworICBsZXQgYWRkID0gaXRlbS5jb250ZXh0LmFkZDsKKyAgaXRlbS5jb250ZXh0
LmFkZCA9IGZ1bmN0aW9uIGl0ZW1Db250ZXh0QWRkKCkgeworICAgIGxldCBhcmdzID0gQXJyYXku
c2xpY2UoYXJndW1lbnRzKTsKKyAgICBhZGQuYXBwbHkoaXRlbS5jb250ZXh0LCBhcmdzKTsKKyAg
ICBpZiAoYXJncy5zb21lKGZ1bmN0aW9uIChhKSBhIGluc3RhbmNlb2YgVVJMQ29udGV4dCkpCisg
ICAgICBwcml2YXRlUHJvcHMud29ya2VyUmVnLmRlc3Ryb3lVbm5lZWRlZFdvcmtlcnMoKTsKKyAg
fTsKKworICBsZXQgcmVtb3ZlID0gaXRlbS5jb250ZXh0LnJlbW92ZTsKKyAgaXRlbS5jb250ZXh0
LnJlbW92ZSA9IGZ1bmN0aW9uIGl0ZW1Db250ZXh0UmVtb3ZlKCkgeworICAgIGxldCBhcmdzID0g
QXJyYXkuc2xpY2UoYXJndW1lbnRzKTsKKyAgICByZW1vdmUuYXBwbHkoaXRlbS5jb250ZXh0LCBh
cmdzKTsKKyAgICBpZiAoYXJncy5zb21lKGZ1bmN0aW9uIChhKSBhIGluc3RhbmNlb2YgVVJMQ29u
dGV4dCkpCisgICAgICBwcml2YXRlUHJvcHMud29ya2VyUmVnLmNyZWF0ZU5lZWRlZFdvcmtlcnMo
KTsKKyAgfTsKIH0KIAogLy8gRG9lcyBhIGJpbmFyeSBzZWFyY2ggb24gZWx0cywgYSBOb2RlTGlz
dCwgYW5kIHJldHVybnMgdGhlIERPTSBlbGVtZW50CiAvLyBiZWZvcmUgd2hpY2ggYW4gaXRlbSB3
aXRoIHRhcmdldExhYmVsIHNob3VsZCBiZSBpbnNlcnRlZC4gIG51bGwgaXMgcmV0dXJuZWQKIC8v
IGlmIHRoZSBuZXcgaXRlbSBzaG91bGQgYmUgaW5zZXJ0ZWQgYXQgdGhlIGVuZC4KIGZ1bmN0aW9u
IGluc2VydGlvblBvaW50KHRhcmdldExhYmVsLCBlbHRzKSB7CiAgIGxldCBmcm9tID0gMDsKICAg
bGV0IHRvID0gZWx0cy5sZW5ndGggLSAxOwpAQCAtMzg3LDQxICs0MjAsNDQgQEAgbGV0IGJyb3dz
ZXJNYW5hZ2VyID0gewogICB3aW5kb3dzOiBbXSwKIAogICAvLyBSZWdpc3RlcnMgYW4gaXRlbSB3
aXRoIHRoZSBtYW5hZ2VyLiAgSXQncyBhZGRlZCB0byB0aGUgY29udGV4dCBtZW51cyBvZgogICAv
LyBhbGwgY3VycmVudGx5IHJlZ2lzdGVyZWQgd2luZG93cywgYW5kIHdoZW4gbmV3IHdpbmRvd3Mg
YXJlIHJlZ2lzdGVyZWQgaXQKICAgLy8gd2lsbCBiZSBhZGRlZCB0byB0aGVtLCB0b28uCiAgIGFk
ZEl0ZW06IGZ1bmN0aW9uIGJyb3dzZXJNYW5hZ2VyX2FkZEl0ZW0oaXRlbSkgewogICAgIHRoaXMu
aXRlbXMucHVzaChpdGVtKTsKICAgICB0aGlzLndpbmRvd3MuZm9yRWFjaChmdW5jdGlvbiAodykg
dy5hZGRJdGVtcyhbaXRlbV0pKTsKLSAgICB0aGlzLndvcmtlclJlZy5yZWdpc3Rlckl0ZW1zKFtp
dGVtXSk7CiAgIH0sCiAKICAgLy8gUmVnaXN0ZXJzIHRoZSBtYW5hZ2VyIHRvIGxpc3RlbiBmb3Ig
d2luZG93IG9wZW5pbmdzIGFuZCBjbG9zaW5ncy4gIE5vdGUKICAgLy8gdGhhdCBjYWxsaW5nIHRo
aXMgbWV0aG9kIGNhbiBjYXVzZSBvblRyYWNrIHRvIGJlIGNhbGxlZCBpbW1lZGlhdGVseSBpZgog
ICAvLyB0aGVyZSBhcmUgb3BlbiB3aW5kb3dzLgogICBpbml0OiBmdW5jdGlvbiBicm93c2VyTWFu
YWdlcl9pbml0KCkgewogICAgIHJlcXVpcmUoInVubG9hZCIpLmVuc3VyZSh0aGlzKTsKLSAgICB0
aGlzLndvcmtlclJlZyA9IG5ldyBXb3JrZXJSZWdpc3RyeSgpOwogICAgIGxldCB3aW5kb3dUcmFj
a2VyID0gbmV3IChyZXF1aXJlKCJ3aW5kb3ctdXRpbHMiKS5XaW5kb3dUcmFja2VyKSh0aGlzKTsK
IAogICAgIC8vIE9uIGlubmVyLXdpbmRvdy1kZXN0cm95ZWQsIHJlbW92ZSB0aGUgZGVzdHJveWVk
IGlubmVyIHdpbmRvdydzIG91dGVyCi0gICAgLy8gd2luZG93IGZyb20gdGhlIHdvcmtlciByZWdp
c3RyeS4KKyAgICAvLyB3aW5kb3cgZnJvbSBhbGwgaXRlbXMnIHdvcmtlciByZWdpc3RyaWVzLgog
ICAgIG9ic2VydmVyU2Vydi5hZGQoImlubmVyLXdpbmRvdy1kZXN0cm95ZWQiLCBmdW5jdGlvbiBv
YnNlcnZlKHN1YmopIHsKICAgICAgIGxldCBpbm5lcldpbklEID0gc3Viai5RdWVyeUludGVyZmFj
ZShDaS5uc0lTdXBwb3J0c1BSVWludDY0KS5kYXRhOwotICAgICAgdGhpcy53b3JrZXJSZWcudW5y
ZWdpc3RlckNvbnRlbnRXaW4oaW5uZXJXaW5JRCk7CisgICAgICB0aGlzLml0ZW1zLmZvckVhY2go
ZnVuY3Rpb24gKGl0ZW0pIHsKKyAgICAgICAgbGV0IHdvcmtlclJlZyA9IGl0ZW0udmFsdWVPZihQ
UklWQVRFX1BST1BTX0tFWSkud29ya2VyUmVnOworICAgICAgICB3b3JrZXJSZWcudW5yZWdpc3Rl
ckNvbnRlbnRXaW4oaW5uZXJXaW5JRCk7CisgICAgICB9KTsKICAgICB9LCB0aGlzKTsKICAgfSwK
IAogICAvLyBXaGVuIHRoZSB3aW5kb3cgdHJhY2tlciBpcyB1bmxvYWRlZCwgaXQnbGwgY2FsbCBv
dXIgb25VbnRyYWNrIGZvciBldmVyeQogICAvLyBvcGVuIGJyb3dzZXIgd2luZG93LCBzbyB0aGVy
ZSdzIG5vIG5lZWQgdG8gZG8gdGhhdCBoZXJlLiAgVGhlIG9ubHkgb3RoZXIKLSAgLy8gdGhpbmdz
IHRvIGNsZWFuIHVwIGFyZSBpdGVtcyBhbmQgdGhlIHdvcmtlciByZWdpc3RyeS4KKyAgLy8gdGhp
bmdzIHRvIGNsZWFuIHVwIGFyZSBpdGVtcyBhbmQgdGhlaXIgd29ya2VyIHJlZ2lzdHJpZXMuCiAg
IHVubG9hZDogZnVuY3Rpb24gYnJvd3Nlck1hbmFnZXJfdW5sb2FkKCkgeworICAgIHRoaXMuaXRl
bXMuZm9yRWFjaChmdW5jdGlvbiAoaXRlbSkgeworICAgICAgaXRlbS52YWx1ZU9mKFBSSVZBVEVf
UFJPUFNfS0VZKS53b3JrZXJSZWcuZGVzdHJveSgpOworICAgIH0pOwogICAgIHRoaXMuaXRlbXMu
c3BsaWNlKDAsIHRoaXMuaXRlbXMubGVuZ3RoKTsKLSAgICB0aGlzLndvcmtlclJlZy5kZXN0cm95
KCk7CiAgIH0sCiAKICAgLy8gUmVnaXN0ZXJzIGEgd2luZG93IHdpdGggdGhlIG1hbmFnZXIuICBU
aGlzIGlzIGEgV2luZG93VHJhY2tlciBjYWxsYmFjay4KICAgb25UcmFjazogZnVuY3Rpb24gYnJv
d3Nlck1hbmFnZXJfb25UcmFjayh3aW5kb3cpIHsKICAgICBpZiAodGhpcy5faXNCcm93c2VyV2lu
ZG93KHdpbmRvdykpIHsKICAgICAgIGxldCB3aW4gPSBuZXcgQnJvd3NlcldpbmRvdyh3aW5kb3cp
OwogICAgICAgdGhpcy53aW5kb3dzLnB1c2god2luKTsKICAgICAgIHdpbi5hZGRJdGVtcyh0aGlz
Lml0ZW1zKTsKQEAgLTQ0NSwxNyArNDgxLDE3IEBAIGxldCBicm93c2VyTWFuYWdlciA9IHsKICAg
Ly8gVW5yZWdpc3RlcnMgYW4gaXRlbSBmcm9tIHRoZSBtYW5hZ2VyLiAgSXQncyByZW1vdmVkIGZy
b20gdGhlIGNvbnRleHQgbWVudXMKICAgLy8gb2YgYWxsIHdpbmRvd3MgdGhhdCBhcmUgY3VycmVu
dGx5IHJlZ2lzdGVyZWQuICBJZiB0aGUgaXRlbSBpcyBub3QKICAgLy8gcmVnaXN0ZXJlZCwgdGhp
cyBpcyBhIG5vLW9wLgogICByZW1vdmVJdGVtOiBmdW5jdGlvbiBicm93c2VyTWFuYWdlcl9yZW1v
dmVJdGVtKGl0ZW0pIHsKICAgICBsZXQgaWR4ID0gdGhpcy5pdGVtcy5pbmRleE9mKGl0ZW0pOwog
ICAgIGlmIChpZHggPj0gMCkgewogICAgICAgdGhpcy5pdGVtcy5zcGxpY2UoaWR4LCAxKTsKICAg
ICAgIHRoaXMud2luZG93cy5mb3JFYWNoKGZ1bmN0aW9uICh3KSB3LnJlbW92ZUl0ZW1zKFtpdGVt
XSkpOwotICAgICAgdGhpcy53b3JrZXJSZWcudW5yZWdpc3Rlckl0ZW1zKFtpdGVtXSk7CisgICAg
ICBpdGVtLnZhbHVlT2YoUFJJVkFURV9QUk9QU19LRVkpLndvcmtlclJlZy5kZXN0cm95KCk7CiAg
ICAgfQogICB9LAogCiAgIF9pc0Jyb3dzZXJXaW5kb3c6IGZ1bmN0aW9uIGJyb3dzZXJNYW5hZ2Vy
X19pc0Jyb3dzZXJXaW5kb3cod2luKSB7CiAgICAgbGV0IHdpblR5cGUgPSB3aW4uZG9jdW1lbnQu
ZG9jdW1lbnRFbGVtZW50LmdldEF0dHJpYnV0ZSgid2luZG93dHlwZSIpOwogICAgIHJldHVybiB3
aW5UeXBlID09PSAibmF2aWdhdG9yOmJyb3dzZXIiOwogICB9CiB9OwpAQCAtNDkxLDIzMiArNTI3
LDEyNSBAQCBjb25zdCBDb250ZXh0TWVudVdvcmtlciA9IFdvcmtlci5jb21wb3NlKHsKICAgLy8g
Y2xpY2tlZC4KICAgZmlyZUNsaWNrOiBmdW5jdGlvbiBDTVdfZmlyZUNsaWNrKHBvcHVwTm9kZSwg
Y2xpY2tlZEl0ZW1EYXRhKSB7CiAgICAgdGhpcy5fcG9ydC5fZW1pdCgiY2xpY2siLCBwb3B1cE5v
ZGUsIGNsaWNrZWRJdGVtRGF0YSk7CiAgIH0KIH0pOwogCiAKIC8vIFRoaXMgY2xhc3MgY3JlYXRl
cyBhbmQgc3RvcmVzIGNvbnRlbnQgd29ya2VycyBmb3IgcGFpcnMgb2YgbWVudSBpdGVtcyBhbmQK
LS8vIGNvbnRlbnQgd2luZG93cy4gIFNpbmNlIHdvcmtlcnMgbmVlZCB0byBiZSBsb29rZWQgdXAg
ZXZlcnkgdGltZSB0aGUgY29udGV4dAotLy8gbWVudSBpcyBzaG93biwgdGhlIG1haW4gcHVycG9z
ZSBvZiB0aGlzIGNsYXNzLCBpbiBhZGRpdGlvbiB0byBjcmVhdGluZyBhbmQKLS8vIHN0b3Jpbmcg
d29ya2VycywgaXMgdG8gcHJvdmlkZSBmYXN0IGxvb2t1cCBvZiB3b3JrZXJzIGdpdmVuIGEgbWVu
dSBpdGVtIGFuZAotLy8gY29udGVudCB3aW5kb3cuCi1mdW5jdGlvbiBXb3JrZXJSZWdpc3RyeSgp
IHsKLSAgLy8gVGhpcyBpcyBhIG1hdHJpeC4gIFRoZSBmaXJzdCBpbmRleCBhZGRyZXNzZXMgY29u
dGVudCB3aW5kb3cga2V5cywgdGhlCi0gIC8vIHNlY29uZCBtZW51IGl0ZW0ga2V5cy4gIEVhY2gg
ZW50cnkgaW4gdGhlIG1hdHJpeCBzdG9yZXMgd29ya2VycyBmb3IgcGFpcnMKLSAgLy8gb2YgY29u
dGVudCB3aW5kb3dzIGFuZCBtZW51IGl0ZW1zLgotICAvLwotICAvLyBNb3JlIHNwZWNpZmljYWxs
eSwgd29ya2Vyc1t3XVtpXSBpcyBhbiBhcnJheSBvZiBvYmplY3RzIHsgaXRlbSwgd29ya2VyIH0u
Ci0gIC8vIHcgaXMgYSBjb250ZW50IHdpbmRvdyBrZXkuICBpIGlzIGEgbWVudSBpdGVtIGtleS4g
IGl0ZW0gaXMgYSBtZW51IGl0ZW0KLSAgLy8gd2hvc2Uga2V5IGlzIGkuICB3b3JrZXIgaXMgdGhl
IGNvbnRlbnQgd29ya2VyIGNyZWF0ZWQgZnJvbSB0aGUgd2luZG93LWl0ZW0KLSAgLy8gcGFpci4K
LSAgLy8KLSAgLy8gS2V5cyBhcmUganVzdCBhIHdheSB0byBwcm92aWRlIE8oMSkgbG9va3VwIG9m
IGEgd2luZG93IG9yIGl0ZW0uICBBY3R1YWxseSwKLSAgLy8gdW5saWtlIHdpbmRvdyBrZXlzLCBt
ZW51IGl0ZW0ga2V5cyBhcmUgbm90IHJlcXVpcmVkIHRvIGJlIHVuaXF1ZSwgd2hpY2ggaGFzCi0g
IC8vIHR3byBjb25zZXF1ZW5jZXM6IDEpIG1lbnUgaXRlbSBsb29rdXAgdXNpbmcgYSBrZXkgbWF5
IGJlIG1vcmUgdGhhbiBPKDEpIGluCi0gIC8vIHRpbWUsIGFuZCAyKSB3b3JrZXJzW3ddW2ldIGlz
IGFuIGFycmF5IGFuZCBub3QgYSBzaW5nbGUgb2JqZWN0LiAgS2V5cyBhcmUKLSAgLy8gbm90IGV4
cGVjdGVkIHRvIGNoYW5nZSBvdmVyIHRoZSBsaWZldGltZSBvZiBhIHdpbmRvdyBvciBtZW51IGl0
ZW0uCi0gIC8vCi0gIC8vIFRoaXMgc3RydWN0dXJlIGlzIGZhaXJseSBzaW1wbGUgYW5kIGFsbG93
cyB3b3JrZXIgbG9va3VwcyBpbiBjb25zdGFudCB0aW1lCi0gIC8vIGluIHRoZSBiZXN0IGNhc2Uu
ICBJbiB0aGUgd29yc3QgY2FzZSwgaG93ZXZlciAtLSB3aGVuIGFsbCBtZW51IGl0ZW1zIGhhdmUK
LSAgLy8gdGhlIHNhbWUga2V5IC0tIGxvb2t1cCBpcyBPKEkpLCB3aGVyZSBJIGlzIHRoZSBudW1i
ZXIgb2YgaXRlbXMgaW4gdGhlCi0gIC8vIHJlZ2lzdHJ5LiAgSSBkb24ndCBleHBlY3QgYW55IGdp
dmVuIGRldmVsb3BlciB0byBjcmVhdGUgbWFueSBpdGVtcyB3aXRoIHRoZQotICAvLyBzYW1lIGtl
eSwgc28gSSB0aGluayBpdCdzIGEgZ29vZCB0cmFkZS1vZmYuCi0gIC8vCi0gIC8vIElmIHRoZXJl
IGFyZSByZWdpc3RlcmVkIHdpbmRvd3MgYnV0IG5vIHJlZ2lzdGVyZWQgaXRlbXMgb3IgdmljZSB2
ZXJzYSwgdGhpcwotICAvLyB3aWxsIGJlIGVtcHR5LgotICB0aGlzLndvcmtlcnMgPSB7fTsKKy8v
IGNvbnRlbnQgd2luZG93cy4gIFVzZSBvbmUgaW5zdGFuY2UgZm9yIGVhY2ggaXRlbS4gIE5vdCBh
bGwgcGFpcnMgbmVlZCBhCisvLyB3b3JrZXI6IGlmIGFuIGl0ZW0gaGFzIGEgVVJMIGNvbnRleHQg
dGhhdCBkb2VzIG5vdCBtYXRjaCBhIHdpbmRvdydzIHBhZ2UsCisvLyB0aGVuIG5vIHdvcmtlciBp
cyBjcmVhdGVkIGZvciB0aGUgcGFpci4KK2Z1bmN0aW9uIFdvcmtlclJlZ2lzdHJ5KGl0ZW0pIHsK
KyAgdGhpcy5pdGVtID0gaXRlbTsKIAotICAvLyBBIG1hcCBvZiBpdGVtcywgaXRlbSBrZXkgPT4g
aXRlbSBsaXN0LiAgSXRlbSBrZXlzIGFyZSBub3QgdW5pcXVlLCBzbyBlYWNoCi0gIC8vIG1hcHMg
dG8gYSBsaXN0IG9mIGl0ZW1zIHdpdGggdGhlIHNhbWUga2V5LgotICB0aGlzLml0ZW1zID0ge307
CisgIC8vIGlubm5lciB3aW5kb3cgSUQgPT4geyB3aW4sIHdvcmtlciB9CisgIHRoaXMud2luV29y
a2VycyA9IHt9OwogCi0gIC8vIEEgbWFwIG9mIGNvbnRlbnQgd2luZG93cywgd2luZG93IGtleSA9
PiB3aW5kb3cuCi0gIHRoaXMud2lucyA9IHt9OworICAvLyBpbm5lciB3aW5kb3cgSUQgPT4gY29u
dGVudCB3aW5kb3cKKyAgdGhpcy53aW5zV2l0aG91dFdvcmtlcnMgPSB7fTsKIH0KIAogV29ya2Vy
UmVnaXN0cnkucHJvdG90eXBlID0gewogCi0gIC8vIFJlZ2lzdGVycyBhIGNvbnRlbnQgd2luZG93
LCBjcmVhdGluZyB3b3JrZXJzIGZvciBlYWNoIHBhaXIgZm9ybWVkIGJ5IHRoZQotICAvLyB3aW5k
b3cgYW5kIGFsbCBwcmV2aW91c2x5IHJlZ2lzdGVyZWQgbWVudSBpdGVtcy4KKyAgLy8gUmVnaXN0
ZXJzIGEgY29udGVudCB3aW5kb3csIGNyZWF0aW5nIGEgd29ya2VyIGZvciBpdCBpZiBpdCBuZWVk
cyBvbmUuCiAgIHJlZ2lzdGVyQ29udGVudFdpbjogZnVuY3Rpb24gV1JfcmVnaXN0ZXJDb250ZW50
V2luKHdpbikgewotICAgIGxldCB3aW5LZXkgPSB0aGlzLl93aW5LZXkod2luKTsKLSAgICBmb3Ig
KGxldCBbaXRlbUtleSwgaXRlbUxpc3RdIGluIEl0ZXJhdG9yKHRoaXMuaXRlbXMpKSB7Ci0gICAg
ICBpdGVtTGlzdC5mb3JFYWNoKGZ1bmN0aW9uIChpdGVtKSB7Ci0gICAgICAgIHRoaXMuX3JlZ2lz
dGVyUGFpcih3aW4sIHdpbktleSwgaXRlbSwgaXRlbUtleSk7Ci0gICAgICB9LCB0aGlzKTsKLSAg
ICB9Ci0gICAgdGhpcy53aW5zW3dpbktleV0gPSB3aW47Ci0gIH0sCi0KLSAgLy8gUmVnaXN0ZXJz
IGFuIGFycmF5IG9mIG1lbnUgaXRlbXMsIGNyZWF0aW5nIHdvcmtlcnMgZm9yIGVhY2ggcGFpciBm
b3JtZWQgYnkKLSAgLy8gdGhlIGl0ZW1zIGFuZCBhbGwgcHJldmlvdXNseSByZWdpc3RlcmVkIGNv
bnRlbnQgd2luZG93cy4KLSAgcmVnaXN0ZXJJdGVtczogZnVuY3Rpb24gV1JfcmVnaXN0ZXJJdGVt
cyhpdGVtcykgewotICAgIGl0ZW1zLmZvckVhY2goZnVuY3Rpb24gKGl0ZW0pIHsKLSAgICAgIGxl
dCBpdGVtS2V5ID0gdGhpcy5faXRlbUtleShpdGVtKTsKLSAgICAgIGZvciAobGV0IFt3aW5LZXks
IHdpbl0gaW4gSXRlcmF0b3IodGhpcy53aW5zKSkKLSAgICAgICAgdGhpcy5fcmVnaXN0ZXJQYWly
KHdpbiwgd2luS2V5LCBpdGVtLCBpdGVtS2V5KTsKLSAgICAgIHRoaXMuaXRlbXNbaXRlbUtleV0g
PSB0aGlzLml0ZW1zW2l0ZW1LZXldIHx8IFtdOwotICAgICAgdGhpcy5pdGVtc1tpdGVtS2V5XS5w
dXNoKGl0ZW0pOwotICAgIH0sIHRoaXMpOworICAgIGxldCBpbm5lcldpbklEID0gdGhpcy5faW5u
ZXJXaW5JRCh3aW4pOworICAgIGlmICh0aGlzLl9kb2VzVVJMTmVlZFdvcmtlcih3aW4uZG9jdW1l
bnQuVVJMKSkKKyAgICAgIHRoaXMud2luV29ya2Vyc1tpbm5lcldpbklEXSA9IHsgd2luOiB3aW4s
IHdvcmtlcjogdGhpcy5fbWFrZVdvcmtlcih3aW4pIH07CisgICAgZWxzZQorICAgICAgdGhpcy53
aW5zV2l0aG91dFdvcmtlcnNbaW5uZXJXaW5JRF0gPSB3aW47CiAgIH0sCiAKLSAgLy8gVW5yZWdp
c3RlcnMgYSBjb250ZW50IHdpbmRvdywgZGVzdHJveWluZyBhbGwgcmVsYXRlZCB3b3JrZXJzLgor
ICAvLyBVbnJlZ2lzdGVycyBhIGNvbnRlbnQgd2luZG93LCBkZXN0cm95aW5nIGl0cyByZWxhdGVk
IHdvcmtlciBpZiBpdCBoYXMgb25lLgogICB1bnJlZ2lzdGVyQ29udGVudFdpbjogZnVuY3Rpb24g
V1JfdW5yZWdpc3RlckNvbnRlbnRXaW4oaW5uZXJXaW5JRCkgewotICAgIGxldCB3aW5LZXkgPSBp
bm5lcldpbklEOwotCiAgICAgLy8gU29tZXRpbWVzIGlubmVyLXdpbmRvdy1kZXN0cm95ZWQgaXMg
c2VudCBmb3IgYSB3aW5kb3cgdGhhdCdzIG5vdAogICAgIC8vIHJlZ2lzdGVyZWQsIHdoaWNoIGlt
cGxpZXMgdGhhdCBET01Db250ZW50TG9hZGVkIGlzIG5vdCBkaXNwYXRjaGVkIHRvIGFueQogICAg
IC8vIHRhYmJyb3dzZXIgZm9yIHRoYXQgaW5uZXIgd2luZG93J3Mgb3V0ZXIgd2luZG93Li4uICBT
byByYXRoZXIgdGhhbgogICAgIC8vIGVycm9uZW91c2x5IHRocm93aW5nIGFuIGVycm9yIGlmIHRo
ZSB3aW5kb3cgaXMgbm90IHJlZ2lzdGVyZWQsIGRvbid0CiAgICAgLy8gYXNzdW1lIHRoYXQgdGhl
IHdpbmRvdyBpcyByZWdpc3RlcmVkIGluIHRoZSBmaXJzdCBwbGFjZS4KLQotICAgIC8vIFJlbW92
ZSB0aGUgd2luZG93J3MgZW50cnkgaW4gdGhlIHdvcmtlciBtYXRyaXguCi0gICAgaWYgKHdpbktl
eSBpbiB0aGlzLndvcmtlcnMpIHsKLSAgICAgIGxldCBpdGVtS2V5VG9FbnRyaWVzTWFwID0gdGhp
cy53b3JrZXJzW3dpbktleV07Ci0gICAgICBmb3IgZWFjaCAobGV0IGVudHJpZXMgaW4gaXRlbUtl
eVRvRW50cmllc01hcCkKLSAgICAgICAgZW50cmllcy5mb3JFYWNoKGZ1bmN0aW9uIChlbnRyeSkg
dGhpcy5fZGVzdHJveUVudHJ5KGVudHJ5KSwgdGhpcyk7Ci0gICAgICBkZWxldGUgdGhpcy53b3Jr
ZXJzW3dpbktleV07CisgICAgaWYgKGlubmVyV2luSUQgaW4gdGhpcy53aW5Xb3JrZXJzKSB7Cisg
ICAgICBsZXQgd2luV29ya2VyID0gdGhpcy53aW5Xb3JrZXJzW2lubmVyV2luSURdOworICAgICAg
d2luV29ya2VyLndvcmtlci5kZXN0cm95KCk7CisgICAgICBkZWxldGUgd2luV29ya2VyLndvcmtl
cjsKKyAgICAgIGRlbGV0ZSB3aW5Xb3JrZXIud2luOworICAgICAgZGVsZXRlIHRoaXMud2luV29y
a2Vyc1tpbm5lcldpbklEXTsKICAgICB9Ci0KLSAgICAvLyBSZW1vdmUgdGhlIHdpbmRvdyBmcm9t
IHRoZSB3aW5kb3cgbWFwLgotICAgIGRlbGV0ZSB0aGlzLndpbnNbd2luS2V5XTsKLSAgfSwKLQot
ICAvLyBVbnJlZ2lzdGVycyBhbiBhcnJheSBvZiBtZW51IGl0ZW1zLCBkZXN0cm95aW5nIGFsbCBy
ZWxhdGVkIHdvcmtlcnMuCi0gIHVucmVnaXN0ZXJJdGVtczogZnVuY3Rpb24gV1JfdW5yZWdpc3Rl
ckl0ZW1zKGl0ZW1zKSB7Ci0gICAgLy8gUmVtb3ZlIGVhY2ggaXRlbSBpbiBlYWNoIHdpbmRvdy1y
b3cgaW4gdGhlIHdvcmtlciBtYXRyaXguCi0gICAgaXRlbXMuZm9yRWFjaChmdW5jdGlvbiAoaXRl
bSkgewotICAgICAgbGV0IGl0ZW1LZXkgPSB0aGlzLl9pdGVtS2V5KGl0ZW0pOwotICAgICAgZm9y
IChsZXQgW3dpbktleSwgd2luXSBpbiBJdGVyYXRvcih0aGlzLndpbnMpKSB7Ci0gICAgICAgIGxl
dCBudW1FbnRyaWVzRm9yS2V5UGFpciA9IHRoaXMuX3VucmVnaXN0ZXJQYWlyKHdpbktleSwgaXRl
bSwgaXRlbUtleSk7Ci0KLSAgICAgICAgLy8gSWYgdGhlcmUgYXJlIG5vIG1vcmUgd29ya2VyIGVu
dHJpZXMgZm9yIHRoaXMgd2luZG93IGtleSBhbmQgaXRlbSBrZXkKLSAgICAgICAgLy8gcGFpciwg
cmVtb3ZlIHRoZSBpdGVtLWNvbHVtbi4KLSAgICAgICAgaWYgKCFudW1FbnRyaWVzRm9yS2V5UGFp
cikKLSAgICAgICAgICBkZWxldGUgdGhpcy53b3JrZXJzW3dpbktleV1baXRlbUtleV07Ci0gICAg
ICB9Ci0KLSAgICAgIC8vIFJlbW92ZSB0aGUgaXRlbSBmcm9tIGl0cyBsaXN0IGluIHRoZSBtYXAg
b2YgaXRlbXMuCi0gICAgICBpZiAoIShpdGVtS2V5IGluIHRoaXMuaXRlbXMpKQotICAgICAgICB0
aHJvdyBuZXcgRXJyb3IoIkludGVybmFsIGVycm9yOiBpdGVtIGtleSBub3QgaW4gaXRlbSBtYXAu
Iik7Ci0gICAgICBsZXQgaXRlbUxpc3QgPSB0aGlzLml0ZW1zW2l0ZW1LZXldOwotICAgICAgbGV0
IGlkeCA9IGl0ZW1MaXN0LmluZGV4T2YoaXRlbSk7Ci0gICAgICBpZiAoaWR4IDwgMCkKLSAgICAg
ICAgdGhyb3cgbmV3IEVycm9yKCJJbnRlcm5hbCBlcnJvcjogaXRlbSBub3QgaW4gaXRlbSBsaXN0
LiIpOwotICAgICAgaXRlbUxpc3Quc3BsaWNlKGlkeCwgMSk7Ci0KLSAgICAgIC8vIFJlbW92ZSB0
aGUgaXRlbSBrZXkgZnJvbSB0aGUgbWFwIGlmIGl0cyBjaGFpbiBpcyBlbXB0eS4KLSAgICAgIGlm
ICghaXRlbUxpc3QubGVuZ3RoKQotICAgICAgICBkZWxldGUgdGhpcy5pdGVtc1tpdGVtS2V5XTsK
LSAgICB9LCB0aGlzKTsKKyAgICBlbHNlCisgICAgICBkZWxldGUgdGhpcy53aW5zV2l0aG91dFdv
cmtlcnNbaW5uZXJXaW5JRF07CiAgIH0sCiAKLSAgLy8gUmV0dXJucyB0aGUgd29ya2VyIGZvciB0
aGUgZ2l2ZW4gd2luZG93LWl0ZW0gcGFpciwgb3IgbnVsbCBpZiBub25lIGV4aXN0cy4KLSAgZmlu
ZDogZnVuY3Rpb24gV1JfZmluZChjb250ZW50V2luLCBpdGVtKSB7Ci0gICAgbGV0IHdpbktleSA9
IHRoaXMuX3dpbktleShjb250ZW50V2luKTsKLSAgICBpZiAod2luS2V5IGluIHRoaXMud29ya2Vy
cykgewotICAgICAgbGV0IGl0ZW1LZXkgPSB0aGlzLl9pdGVtS2V5KGl0ZW0pOwotICAgICAgaWYg
KGl0ZW1LZXkgaW4gdGhpcy53b3JrZXJzW3dpbktleV0pIHsKLSAgICAgICAgbGV0IGVudHJpZXMg
PSB0aGlzLndvcmtlcnNbd2luS2V5XVtpdGVtS2V5XTsKLSAgICAgICAgbGV0IGlkeCA9IHRoaXMu
X2luZGV4T2ZFbnRyeShlbnRyaWVzLCBpdGVtKTsKLSAgICAgICAgaWYgKGlkeCA+PSAwKQotICAg
ICAgICAgIHJldHVybiBlbnRyaWVzW2lkeF0ud29ya2VyOwotICAgICAgfQorICAvLyBDcmVhdGVz
IGEgd29ya2VyIGZvciBlYWNoIHdpbmRvdyB0aGF0IG5lZWRzIGEgd29ya2VyIGJ1dCBkb2Vzbid0
IGhhdmUgb25lLgorICBjcmVhdGVOZWVkZWRXb3JrZXJzOiBmdW5jdGlvbiBXUl9jcmVhdGVOZWVk
ZWRXb3JrZXJzKCkgeworICAgIGZvciAobGV0IFtpbm5lcldpbklELCB3aW5dIGluIEl0ZXJhdG9y
KHRoaXMud2luc1dpdGhvdXRXb3JrZXJzKSkgeworICAgICAgZGVsZXRlIHRoaXMud2luc1dpdGhv
dXRXb3JrZXJzW2lubmVyV2luSURdOworICAgICAgdGhpcy5yZWdpc3RlckNvbnRlbnRXaW4od2lu
KTsKICAgICB9Ci0gICAgcmV0dXJuIG51bGw7CiAgIH0sCiAKLSAgLy8gVW5yZWdpc3RlcnMgYWxs
IGNvbnRlbnQgd2luZG93cyBhbmQgaXRlbXMsIGRlc3Ryb3lpbmcgYWxsIHdvcmtlcnMuCi0gIGRl
c3Ryb3k6IGZ1bmN0aW9uIFdSX2Rlc3Ryb3koKSB7Ci0gICAgZm9yIChsZXQgd2luS2V5IGluIHRo
aXMud2lucykKLSAgICAgIHRoaXMudW5yZWdpc3RlckNvbnRlbnRXaW4od2luS2V5KTsKLQotICAg
IC8vIENhbGxpbmcgdW5yZWdpc3RlckNvbnRlbnRXaW4gZm9yIGFsbCB3aW5kb3dzIGNsZWFycyB0
aGUgd2luZG93IG1hcCBhbmQKLSAgICAvLyB0aGUgd29ya2VyIG1hdHJpeC4gIFRoZSBvbmx5IHRo
aW5nIGxlZnQgdG8gZG8gaXMgY2xlYXIgdGhlIGl0ZW0gbWFwLgotICAgIGZvciAobGV0IFtpdGVt
S2V5LCBpdGVtTGlzdF0gaW4gSXRlcmF0b3IodGhpcy5pdGVtcykpIHsKLSAgICAgIGl0ZW1MaXN0
LnNwbGljZSgwLCBpdGVtTGlzdC5sZW5ndGgpOwotICAgICAgZGVsZXRlIHRoaXMuaXRlbXNbaXRl
bUtleV07CisgIC8vIERlc3Ryb3lzIHRoZSB3b3JrZXIgZm9yIGVhY2ggd2luZG93IHRoYXQgaGFz
IGEgd29ya2VyIGJ1dCBkb2Vzbid0IG5lZWQgaXQuCisgIGRlc3Ryb3lVbm5lZWRlZFdvcmtlcnM6
IGZ1bmN0aW9uIFdSX2Rlc3Ryb3lVbm5lZWRlZFdvcmtlcnMoKSB7CisgICAgZm9yIChsZXQgW2lu
bmVyV2luSUQsIHdpbldvcmtlcl0gaW4gSXRlcmF0b3IodGhpcy53aW5Xb3JrZXJzKSkgeworICAg
ICAgaWYgKCF0aGlzLl9kb2VzVVJMTmVlZFdvcmtlcih3aW5Xb3JrZXIud2luLmRvY3VtZW50LlVS
TCkpIHsKKyAgICAgICAgdGhpcy51bnJlZ2lzdGVyQ29udGVudFdpbihpbm5lcldpbklEKTsKKyAg
ICAgICAgdGhpcy53aW5zV2l0aG91dFdvcmtlcnNbaW5uZXJXaW5JRF0gPSB3aW5Xb3JrZXIud2lu
OworICAgICAgfQogICAgIH0KICAgfSwKIAotICAvLyBDcmVhdGVzIGEgd29ya2VyIGZvciB0aGUg
Z2l2ZW4gd2luZG93LWl0ZW0gcGFpciBhbmQgYWRkcyBpdCB0byB0aGUgd29ya2VyCi0gIC8vIG1h
dHJpeC4KLSAgX3JlZ2lzdGVyUGFpcjogZnVuY3Rpb24gV1JfX3JlZ2lzdGVyUGFpcih3aW4sIHdp
bktleSwgaXRlbSwgaXRlbUtleSkgewotICAgIGxldCB3b3JrZXIgPSB0aGlzLl9tYWtlV29ya2Vy
KHdpbiwgaXRlbSk7Ci0gICAgdGhpcy53b3JrZXJzW3dpbktleV0gPSB0aGlzLndvcmtlcnNbd2lu
S2V5XSB8fCB7fTsKLSAgICB0aGlzLndvcmtlcnNbd2luS2V5XVtpdGVtS2V5XSA9IHRoaXMud29y
a2Vyc1t3aW5LZXldW2l0ZW1LZXldIHx8IFtdOwotICAgIHRoaXMud29ya2Vyc1t3aW5LZXldW2l0
ZW1LZXldLnB1c2goewotICAgICAgd2luOiB3aW4sCi0gICAgICBpdGVtOiBpdGVtLAotICAgICAg
d29ya2VyOiB3b3JrZXIKLSAgICB9KTsKKyAgLy8gUmV0dXJucyB0aGUgd29ya2VyIGZvciB0aGUg
aXRlbS13aW5kb3cgcGFpciBvciBudWxsIGlmIG5vbmUgZXhpc3RzLgorICBmaW5kOiBmdW5jdGlv
biBXUl9maW5kKGNvbnRlbnRXaW4pIHsKKyAgICBsZXQgaW5uZXJXaW5JRCA9IHRoaXMuX2lubmVy
V2luSUQoY29udGVudFdpbik7CisgICAgcmV0dXJuIChpbm5lcldpbklEIGluIHRoaXMud2luV29y
a2VycykgPworICAgICAgICAgICB0aGlzLndpbldvcmtlcnNbaW5uZXJXaW5JRF0ud29ya2VyIDoK
KyAgICAgICAgICAgbnVsbDsKICAgfSwKIAotICAvLyBSZW1vdmVzIHRoZSB3b3JrZXIgZW50cnkg
b2YgdGhlIGdpdmVuIHdpbmRvdy1pdGVtIHBhaXIgZnJvbSB0aGUgd29ya2VyCi0gIC8vIG1hdHJp
eC4gIFJldHVybnMgdGhlIG51bWJlciBvZiByZW1haW5pbmcgaXRlbXMgcGFpcmVkIHdpdGggdGhl
IHdpbmRvdy4KLSAgX3VucmVnaXN0ZXJQYWlyOiBmdW5jdGlvbiBXUl9fdW5yZWdpc3RlclBhaXIo
d2luS2V5LCBpdGVtLCBpdGVtS2V5KSB7Ci0gICAgaWYgKCEod2luS2V5IGluIHRoaXMud29ya2Vy
cykpCi0gICAgICB0aHJvdyBuZXcgRXJyb3IoIkludGVybmFsIGVycm9yOiB3aW5kb3cga2V5IG5v
dCBpbiByZWdpc3RyeS4iKTsKLSAgICBpZiAoIShpdGVtS2V5IGluIHRoaXMud29ya2Vyc1t3aW5L
ZXldKSkKLSAgICAgIHRocm93IG5ldyBFcnJvcigiSW50ZXJuYWwgZXJyb3I6IGl0ZW0ga2V5IG5v
dCBpbiByZWdpc3RyeS4iKTsKLSAgICBsZXQgZW50cmllcyA9IHRoaXMud29ya2Vyc1t3aW5LZXld
W2l0ZW1LZXldOwotICAgIGxldCBpZHggPSB0aGlzLl9pbmRleE9mRW50cnkoZW50cmllcywgaXRl
bSk7Ci0gICAgaWYgKGlkeCA8IDApCi0gICAgICB0aHJvdyBuZXcgRXJyb3IoIkludGVybmFsIGVy
cm9yOiB0YXJnZXQgcGFpciBub3QgZm91bmQuIik7Ci0gICAgdGhpcy5fZGVzdHJveUVudHJ5KGVu
dHJpZXNbaWR4XSk7Ci0gICAgZW50cmllcy5zcGxpY2UoaWR4LCAxKTsKLSAgICByZXR1cm4gZW50
cmllcy5sZW5ndGg7CisgIC8vIFVucmVnaXN0ZXJzIGFsbCBjb250ZW50IHdpbmRvd3MgaW4gdGhl
IHJlZ2lzdHJ5LCBkZXN0cm95aW5nIGFsbCB3b3JrZXJzLgorICBkZXN0cm95OiBmdW5jdGlvbiBX
Ul9kZXN0cm95KCkgeworICAgIGZvciAobGV0IGlubmVyV2luSUQgaW4gdGhpcy53aW5Xb3JrZXJz
KQorICAgICAgdGhpcy51bnJlZ2lzdGVyQ29udGVudFdpbihpbm5lcldpbklEKTsKKyAgICBmb3Ig
KGxldCBpbm5lcldpbklEIGluIHRoaXMud2luc1dpdGhvdXRXb3JrZXJzKQorICAgICAgdGhpcy51
bnJlZ2lzdGVyQ29udGVudFdpbihpbm5lcldpbklEKTsKICAgfSwKIAotICAvLyBSZXR1cm5zIHRo
ZSBpbmRleCBvZiB0aGUgd29ya2VyIGVudHJ5IGluIHRoZSBnaXZlbiBsaXN0IGNvbnRhaW5pbmcg
dGhlCi0gIC8vIGdpdmVuIGl0ZW0uCi0gIF9pbmRleE9mRW50cnk6IGZ1bmN0aW9uIFdSX19pbmRl
eE9mRW50cnkoZW50cmllcywgaXRlbSkgewotICAgIGxldCBpZHggPSAwOwotICAgIGZvciAoOyBp
ZHggPCBlbnRyaWVzLmxlbmd0aDsgaWR4KyspCi0gICAgICBpZiAoZW50cmllc1tpZHhdLml0ZW0g
PT09IGl0ZW0pCi0gICAgICAgIGJyZWFrOwotICAgIHJldHVybiBpZHggPj0gZW50cmllcy5sZW5n
dGggPyAtMSA6IGlkeDsKKyAgLy8gUmV0dXJucyBmYWxzZSBpZiB0aGUgaXRlbSBoYXMgYSBVUkwg
Y29udGV4dCB0aGF0IGRvZXMgbm90IG1hdGNoIHRoZSBnaXZlbgorICAvLyBVUkwuCisgIF9kb2Vz
VVJMTmVlZFdvcmtlcjogZnVuY3Rpb24gV1JfX2RvZXNVUkxOZWVkV29ya2VyKHVybCkgeworICAg
IGZvciAobGV0IGN0eHQgaW4gdGhpcy5pdGVtLmNvbnRleHQpCisgICAgICBpZiAoKGN0eHQgaW5z
dGFuY2VvZiBVUkxDb250ZXh0KSAmJiAhY3R4dC5pc0N1cnJlbnRGb3JVUkwodXJsKSkKKyAgICAg
ICAgcmV0dXJuIGZhbHNlOworICAgIHJldHVybiB0cnVlOwogICB9LAogCi0gIF9tYWtlV29ya2Vy
OiBmdW5jdGlvbiBXUl9fbWFrZVdvcmtlcih3aW4sIGl0ZW0pIHsKKyAgX21ha2VXb3JrZXI6IGZ1
bmN0aW9uIFdSX19tYWtlV29ya2VyKHdpbikgewogICAgIGxldCB3b3JrZXIgPSBDb250ZXh0TWVu
dVdvcmtlcih7CiAgICAgICB3aW5kb3c6IHdpbi53cmFwcGVkSlNPYmplY3QsCi0gICAgICBjb250
ZW50U2NyaXB0OiBpdGVtLmNvbnRlbnRTY3JpcHQsCi0gICAgICBjb250ZW50U2NyaXB0RmlsZTog
aXRlbS5jb250ZW50U2NyaXB0RmlsZSwKKyAgICAgIGNvbnRlbnRTY3JpcHQ6IHRoaXMuaXRlbS5j
b250ZW50U2NyaXB0LAorICAgICAgY29udGVudFNjcmlwdEZpbGU6IHRoaXMuaXRlbS5jb250ZW50
U2NyaXB0RmlsZSwKICAgICAgIG9uRXJyb3I6IGZ1bmN0aW9uIChlcnIpIGNvbnNvbGUuZXhjZXB0
aW9uKGVycikKICAgICB9KTsKLSAgICB3b3JrZXIub24oIm1lc3NhZ2UiLCBmdW5jdGlvbiB3b3Jr
ZXJPbk1lc3NhZ2UobXNnKSB7CisgICAgbGV0IChpdGVtID0gdGhpcy5pdGVtKSB3b3JrZXIub24o
Im1lc3NhZ2UiLCBmdW5jdGlvbiB3b3JrZXJPbk1lc3NhZ2UobXNnKSB7CiAgICAgICB0cnkgewot
ICAgICAgICBpdGVtLnZhbHVlT2YoUFJJVkFURSkuX2VtaXRPbk9iamVjdChpdGVtLCAibWVzc2Fn
ZSIsIG1zZyk7CisgICAgICAgIGxldCBldmVudEVtaXR0ZXIgPSBpdGVtLnZhbHVlT2YoUFJJVkFU
RV9QUk9QU19LRVkpLmV2ZW50RW1pdHRlcjsKKyAgICAgICAgZXZlbnRFbWl0dGVyLl9lbWl0T25P
YmplY3QoaXRlbSwgIm1lc3NhZ2UiLCBtc2cpOwogICAgICAgfQogICAgICAgY2F0Y2ggKGVycikg
ewogICAgICAgICBjb25zb2xlLmV4Y2VwdGlvbihlcnIpOwogICAgICAgfQogICAgIH0pOwogICAg
IHJldHVybiB3b3JrZXI7CiAgIH0sCiAKLSAgX2Rlc3Ryb3lFbnRyeTogZnVuY3Rpb24gV1JfX2Rl
c3Ryb3lFbnRyeShlbnRyeSkgewotICAgIGVudHJ5Lndvcmtlci5kZXN0cm95KCk7Ci0gICAgZGVs
ZXRlIGVudHJ5LndvcmtlcjsKLSAgICBkZWxldGUgZW50cnkuaXRlbTsKLSAgfSwKLQotICBfd2lu
S2V5OiBmdW5jdGlvbiBXUl9fd2luS2V5KHdpbikgeworICBfaW5uZXJXaW5JRDogZnVuY3Rpb24g
V1JfX2lubmVyV2luSUQod2luKSB7CiAgICAgcmV0dXJuIHdpbi4KICAgICAgICAgICAgUXVlcnlJ
bnRlcmZhY2UoQ2kubnNJSW50ZXJmYWNlUmVxdWVzdG9yKS4KICAgICAgICAgICAgZ2V0SW50ZXJm
YWNlKENpLm5zSURPTVdpbmRvd1V0aWxzKS4KICAgICAgICAgICAgY3VycmVudElubmVyV2luZG93
SUQ7Ci0gIH0sCi0KLSAgX2l0ZW1LZXk6IGZ1bmN0aW9uIFdSX19pdGVtS2V5KGl0ZW0pIHsKLSAg
ICAvLyBXZSByZWx5IG9uIGxhYmVsIHJlbWFpbmluZyBjb25zdGFudCBvdmVyIHRoZSBsaWZldGlt
ZSBvZiB0aGUgaXRlbS4KLSAgICByZXR1cm4gaXRlbS5sYWJlbDsKICAgfQogfTsKIAogCiAvLyBL
ZWVwcyB0cmFjayBvZiBhIHNpbmdsZSBicm93c2VyIHdpbmRvdy4gIFJlc3BvbnNpYmxlIGZvciBw
cm92aWRpbmcgYQogLy8gZGVzY3JpcHRpb24gb2YgdGhlIHdpbmRvdydzIGN1cnJlbnQgY29udGV4
dCBhbmQgZGV0ZXJtaW5pbmcgd2hldGhlciBhbiBpdGVtCiAvLyBtYXRjaGVzIHRoZSBjdXJyZW50
IGNvbnRleHQuCiAvLwpAQCAtNzY3LDIyICs2OTYsMjIgQEAgQnJvd3NlcldpbmRvdy5wcm90b3R5
cGUgPSB7CiAgICAgICB9CiAgICAgfQogICAgIHJldHVybiBwb3B1cE5vZGU7CiAgIH0sCiAKICAg
Ly8gUmV0dXJucyB0cnVlIGlmIGFsbCBvZiBpdGVtJ3MgY29udGV4dHMgYXJlIGN1cnJlbnQgaW4g
dGhlIHdpbmRvdy4KICAgYXJlQWxsQ29udGV4dHNDdXJyZW50OiBmdW5jdGlvbiBCV19hcmVBbGxD
b250ZXh0c0N1cnJlbnQoaXRlbSwgcG9wdXBOb2RlKSB7CiAgICAgbGV0IHdpbiA9IHBvcHVwTm9k
ZS5vd25lckRvY3VtZW50LmRlZmF1bHRWaWV3OwotICAgIGxldCB3b3JrZXIgPSBicm93c2VyTWFu
YWdlci53b3JrZXJSZWcuZmluZCh3aW4sIGl0ZW0pOworICAgIGxldCB3b3JrZXIgPSBpdGVtLnZh
bHVlT2YoUFJJVkFURV9QUk9QU19LRVkpLndvcmtlclJlZy5maW5kKHdpbik7CiAKLSAgICAvLyBJ
ZiB0aGUgd29ya2VyIGZvciB0aGUgY29udGVudC13aW5kb3ctaXRlbSBwYWlyIGRvZXNuJ3QgZXhp
c3QgKGUuZy4sCi0gICAgLy8gYmVjYXVzZSB0aGUgcGFnZSBoYXNuJ3QgbG9hZGVkIHlldCksIHdl
IGNhbid0IHJlYWxseSBtYWtlIGEgZ29vZCBkZWNpc2lvbgotICAgIC8vIHNpbmNlIHRoZSBjb250
ZW50IHNjcmlwdCBtYXkgaGF2ZSBhIGNvbnRleHQgbGlzdGVuZXIuICBTbyBqdXN0IGRvbid0IHNo
b3cKLSAgICAvLyB0aGUgaXRlbSBhdCBhbGwuCisgICAgLy8gSWYgdGhlIHdvcmtlciBmb3IgdGhl
IGl0ZW0td2luZG93IHBhaXIgZG9lc24ndCBleGlzdCAoZS5nLiwgYmVjYXVzZSB0aGUKKyAgICAv
LyBwYWdlIGhhc24ndCBsb2FkZWQgeWV0KSwgd2UgY2FuJ3QgcmVhbGx5IG1ha2UgYSBnb29kIGRl
Y2lzaW9uIHNpbmNlIHRoZQorICAgIC8vIGNvbnRlbnQgc2NyaXB0IG1heSBoYXZlIGEgY29udGV4
dCBsaXN0ZW5lci4gIFNvIGp1c3QgZG9uJ3Qgc2hvdyB0aGUgaXRlbQorICAgIC8vIGF0IGFsbC4K
ICAgICBpZiAoIXdvcmtlcikKICAgICAgIHJldHVybiBmYWxzZTsKIAogICAgIC8vIElmIHRoZXJl
IGFyZSBubyBjb250ZXh0cyBnaXZlbiBhdCBhbGwsIHRoZSBwYWdlIGNvbnRleHQgYXBwbGllcy4K
ICAgICBsZXQgaGFzQ29udGVudENvbnRleHQgPSB3b3JrZXIuYW55Q29udGV4dExpc3RlbmVycygp
OwogICAgIGlmICghaGFzQ29udGVudENvbnRleHQgJiYgIWl0ZW0uY29udGV4dC5sZW5ndGgpCiAg
ICAgICByZXR1cm4gbmV3IFBhZ2VDb250ZXh0KCkuaXNDdXJyZW50KHBvcHVwTm9kZSk7CiAKQEAg
LTgxNSwxNyArNzQ0LDE3IEBAIEJyb3dzZXJXaW5kb3cucHJvdG90eXBlID0gewogICAgIHRoaXMu
d2luZG93LmdCcm93c2VyLnJlbW92ZUV2ZW50TGlzdGVuZXIoIkRPTUNvbnRlbnRMb2FkZWQiLCB0
aGlzLCBmYWxzZSk7CiAgIH0sCiAKICAgLy8gRW1pdHMgYSBjbGljayBldmVudCBpbiB0aGUgcG9y
dCBvZiB0aGUgY29udGVudCB3b3JrZXIgcmVsYXRlZCB0byBpdGVtIGFuZAogICAvLyBwb3B1cE5v
ZGUncyBjb250ZW50IHdpbmRvdy4gIExpc3RlbmVycyB3aWxsIGJlIHBhc3NlZCBwb3B1cE5vZGUg
YW5kCiAgIC8vIGNsaWNrZWRJdGVtRGF0YS4KICAgZmlyZUNsaWNrOiBmdW5jdGlvbiBCV19maXJl
Q2xpY2soaXRlbSwgcG9wdXBOb2RlLCBjbGlja2VkSXRlbURhdGEpIHsKICAgICBsZXQgd2luID0g
cG9wdXBOb2RlLm93bmVyRG9jdW1lbnQuZGVmYXVsdFZpZXc7Ci0gICAgbGV0IHdvcmtlciA9IGJy
b3dzZXJNYW5hZ2VyLndvcmtlclJlZy5maW5kKHdpbiwgaXRlbSk7CisgICAgbGV0IHdvcmtlciA9
IGl0ZW0udmFsdWVPZihQUklWQVRFX1BST1BTX0tFWSkud29ya2VyUmVnLmZpbmQod2luKTsKICAg
ICBpZiAod29ya2VyKQogICAgICAgd29ya2VyLmZpcmVDbGljayhwb3B1cE5vZGUsIGNsaWNrZWRJ
dGVtRGF0YSk7CiAgIH0sCiAKICAgLy8gUmVtb3ZlcyBhbiBhcnJheSBvZiBpdGVtcyBmcm9tIHRo
ZSB3aW5kb3cncyBjb250ZXh0IG1lbnUuCiAgIHJlbW92ZUl0ZW1zOiBmdW5jdGlvbiBCV19yZW1v
dmVJdGVtcyhpdGVtcykgewogICAgIHRoaXMuY29udGV4dE1lbnVQb3B1cC5yZW1vdmVJdGVtcyhp
dGVtcyk7CiAgIH0sCkBAIC04NDEsMTcgKzc3MCwxOSBAQCBCcm93c2VyV2luZG93LnByb3RvdHlw
ZSA9IHsKICAgICAgIH0KICAgICB9CiAgICAgY2F0Y2ggKGVycikgewogICAgICAgY29uc29sZS5l
eGNlcHRpb24oZXJyKTsKICAgICB9CiAgIH0sCiAKICAgX3JlZ2lzdGVyQ29udGVudFdpbjogZnVu
Y3Rpb24gQldfX3JlZ2lzdGVyQ29udGVudFdpbih3aW4pIHsKLSAgICBicm93c2VyTWFuYWdlci53
b3JrZXJSZWcucmVnaXN0ZXJDb250ZW50V2luKHdpbik7CisgICAgYnJvd3Nlck1hbmFnZXIuaXRl
bXMuZm9yRWFjaChmdW5jdGlvbiAoaXRlbSkgeworICAgICAgaXRlbS52YWx1ZU9mKFBSSVZBVEVf
UFJPUFNfS0VZKS53b3JrZXJSZWcucmVnaXN0ZXJDb250ZW50V2luKHdpbik7CisgICAgfSk7CiAg
IH0KIH07CiAKIAogLy8gUmVwcmVzZW50cyBhIGNvbnRhaW5lciBvZiBpdGVtcyB0aGF0J3MgdGhl
IGNoaWxkIG9mIHRoZSBnaXZlbiBNZW51IGFuZCBQb3B1cC4KIC8vIHBvcHVwRWx0IGlzIGEgPG1l
bnVwb3B1cD4gdGhhdCByZXByZXNlbnRzIHRoZSBwb3B1cCBpbiB0aGUgRE9NLCBhbmQgd2luZG93
IGlzCiAvLyB0aGUgQnJvd3NlcldpbmRvdyBjb250YWluaW5nIHRoZSBwb3B1cC4gIFRoZSBwb3B1
cCBpcyByZXNwb25zaWJsZSBmb3IKIC8vIGNyZWF0aW5nIGFuZCBhZGRpbmcgaXRlbXMgdG8gcG91
cEVsdCBhbmQgaGFuZGxpbmcgY29tbWFuZCBldmVudHMuCmRpZmYgLS1naXQgYS9wYWNrYWdlcy9h
ZGRvbi1raXQvdGVzdHMvdGVzdC1jb250ZXh0LW1lbnUuanMgYi9wYWNrYWdlcy9hZGRvbi1raXQv
dGVzdHMvdGVzdC1jb250ZXh0LW1lbnUuanMKaW5kZXggOWEzNDI1Mi4uODQ2NjEwYiAxMDA2NDQK
LS0tIGEvcGFja2FnZXMvYWRkb24ta2l0L3Rlc3RzL3Rlc3QtY29udGV4dC1tZW51LmpzCisrKyBi
L3BhY2thZ2VzL2FkZG9uLWtpdC90ZXN0cy90ZXN0LWNvbnRleHQtbWVudS5qcwpAQCAtMzAwLDE2
ICszMDAsNzUgQEAgZXhwb3J0cy50ZXN0VVJMQ29udGV4dE5vTWF0Y2ggPSBmdW5jdGlvbiAodGVz
dCkgewogICAgIHRlc3Quc2hvd01lbnUobnVsbCwgZnVuY3Rpb24gKHBvcHVwKSB7CiAgICAgICB0
ZXN0LmNoZWNrTWVudShbXSwgaXRlbXMsIFtdKTsKICAgICAgIHRlc3QuZG9uZSgpOwogICAgIH0p
OwogICB9KTsKIH07CiAKIAorLy8gUmVtb3ZpbmcgYSBub24tbWF0Y2hpbmcgVVJMIGNvbnRleHQg
YWZ0ZXIgaXRzIGl0ZW0gaXMgY3JlYXRlZCBhbmQgdGhlIHBhZ2UgaXMKKy8vIGxvYWRlZCBzaG91
bGQgY2F1c2UgdGhlIGl0ZW0ncyBjb250ZW50IHNjcmlwdCB0byBiZSBldmFsdWF0ZWQuCitleHBv
cnRzLnRlc3RVUkxDb250ZXh0UmVtb3ZlID0gZnVuY3Rpb24gKHRlc3QpIHsKKyAgdGVzdCA9IG5l
dyBUZXN0SGVscGVyKHRlc3QpOworICBsZXQgbG9hZGVyID0gdGVzdC5uZXdMb2FkZXIoKTsKKwor
ICBsZXQgc2hvdWxkQmVFdmFsZWQgPSBmYWxzZTsKKyAgbGV0IGNvbnRleHQgPSBsb2FkZXIuY20u
VVJMQ29udGV4dCgiKi5ib2d1cy5jb20iKTsKKyAgbGV0IGl0ZW0gPSBsb2FkZXIuY20uSXRlbSh7
CisgICAgbGFiZWw6ICJpdGVtIiwKKyAgICBjb250ZXh0OiBjb250ZXh0LAorICAgIGNvbnRlbnRT
Y3JpcHQ6ICdwb3N0TWVzc2FnZSgib2siKTsnLAorICAgIG9uTWVzc2FnZTogZnVuY3Rpb24gKG1z
ZykgeworICAgICAgdGVzdC5hc3NlcnQoc2hvdWxkQmVFdmFsZWQsCisgICAgICAgICAgICAgICAg
ICAiY29udGVudCBzY3JpcHQgc2hvdWxkIGJlIGV2YWx1YXRlZCB3aGVuIGV4cGVjdGVkIik7Cisg
ICAgICBzaG91bGRCZUV2YWxlZCA9IGZhbHNlOworICAgICAgdGVzdC5kb25lKCk7CisgICAgfQor
ICB9KTsKKworICB0ZXN0LndpdGhUZXN0RG9jKGZ1bmN0aW9uICh3aW5kb3csIGRvYykgeworICAg
IHNob3VsZEJlRXZhbGVkID0gdHJ1ZTsKKyAgICBpdGVtLmNvbnRleHQucmVtb3ZlKGNvbnRleHQp
OworICB9KTsKK307CisKKworLy8gQWRkaW5nIGEgbm9uLW1hdGNoaW5nIFVSTCBjb250ZXh0IGFm
dGVyIGl0cyBpdGVtIGlzIGNyZWF0ZWQgYW5kIHRoZSBwYWdlIGlzCisvLyBsb2FkZWQgc2hvdWxk
IGNhdXNlIHRoZSBpdGVtJ3Mgd29ya2VyIHRvIGJlIGRlc3Ryb3llZC4KK2V4cG9ydHMudGVzdFVS
TENvbnRleHRBZGQgPSBmdW5jdGlvbiAodGVzdCkgeworICB0ZXN0ID0gbmV3IFRlc3RIZWxwZXIo
dGVzdCk7CisgIGxldCBsb2FkZXIgPSB0ZXN0Lm5ld0xvYWRlcigpOworCisgIGxldCBpdGVtID0g
bG9hZGVyLmNtLkl0ZW0oeyBsYWJlbDogIml0ZW0iIH0pOworCisgIHRlc3Qud2l0aFRlc3REb2Mo
ZnVuY3Rpb24gKHdpbmRvdywgZG9jKSB7CisgICAgbGV0IHByaXZhdGVQcm9wc0tleSA9IGxvYWRl
ci5nbG9iYWxTY29wZS5QUklWQVRFX1BST1BTX0tFWTsKKyAgICBsZXQgd29ya2VyUmVnID0gaXRl
bS52YWx1ZU9mKHByaXZhdGVQcm9wc0tleSkud29ya2VyUmVnOworCisgICAgbGV0IGZvdW5kID0g
ZmFsc2U7CisgICAgZm9yIGVhY2ggKGxldCB3aW5Xb3JrZXIgaW4gd29ya2VyUmVnLndpbldvcmtl
cnMpIHsKKyAgICAgIGlmICh3aW5Xb3JrZXIud2luID09PSB3aW5kb3cpIHsKKyAgICAgICAgZm91
bmQgPSB0cnVlOworICAgICAgICBicmVhazsKKyAgICAgIH0KKyAgICB9CisgICAgdGhpcy50ZXN0
LmFzc2VydChmb3VuZCwgIndpbmRvdyBzaG91bGQgYmUgcHJlc2VudCBpbiB3b3JrZXIgcmVnaXN0
cnkiKTsKKworICAgIGl0ZW0uY29udGV4dC5hZGQobG9hZGVyLmNtLlVSTENvbnRleHQoIiouYm9n
dXMuY29tIikpOworCisgICAgZm9yIGVhY2ggKGxldCB3aW5Xb3JrZXIgaW4gd29ya2VyUmVnLndp
bldvcmtlcnMpCisgICAgICB0aGlzLnRlc3QuYXNzZXJ0Tm90RXF1YWwod2luV29ya2VyLndpbiwg
d2luZG93LAorICAgICAgICAid2luZG93IHNob3VsZCBub3QgYmUgcHJlc2VudCBpbiB3b3JrZXIg
cmVnaXN0cnkiKTsKKworICAgIHRlc3QuZG9uZSgpOworICB9KTsKK307CisKKwogLy8gQ29udGVu
dCBjb250ZXh0cyB0aGF0IHJldHVybiB0cnVlIHNob3VsZCBjYXVzZSB0aGVpciBpdGVtcyB0byBi
ZSBwcmVzZW50CiAvLyBpbiB0aGUgbWVudS4KIGV4cG9ydHMudGVzdENvbnRlbnRDb250ZXh0TWF0
Y2ggPSBmdW5jdGlvbiAodGVzdCkgewogICB0ZXN0ID0gbmV3IFRlc3RIZWxwZXIodGVzdCk7CiAg
IGxldCBsb2FkZXIgPSB0ZXN0Lm5ld0xvYWRlcigpOwogCiAgIGxldCBpdGVtID0gbmV3IGxvYWRl
ci5jbS5JdGVtKHsKICAgICBsYWJlbDogIml0ZW0iLApAQCAtMTI3Myw0MyArMTMzMiwzNSBAQCBU
ZXN0SGVscGVyLnByb3RvdHlwZSA9IHsKICAgZG9uZTogZnVuY3Rpb24gKCkgewogICAgIGZ1bmN0
aW9uIGNvbW1vbkRvbmUoKSB7CiAgICAgICBpZiAodGhpcy50YWIpIHsKICAgICAgICAgdGhpcy50
YWJCcm93c2VyLnJlbW92ZVRhYih0aGlzLnRhYik7CiAgICAgICAgIHRoaXMudGFiQnJvd3Nlci5z
ZWxlY3RlZFRhYiA9IHRoaXMub2xkU2VsZWN0ZWRUYWI7CiAgICAgICB9CiAgICAgICB3aGlsZSAo
dGhpcy5sb2FkZXJzLmxlbmd0aCkgewogICAgICAgICBsZXQgYnJvd3Nlck1hbmFnZXIgPSB0aGlz
LmxvYWRlcnNbMF0uZ2xvYmFsU2NvcGUuYnJvd3Nlck1hbmFnZXI7Ci0gICAgICAgIGxldCBicm93
c2VyV2lucyA9IGJyb3dzZXJNYW5hZ2VyLndpbmRvd3Muc2xpY2UoKTsKKyAgICAgICAgbGV0IGl0
ZW1zID0gYnJvd3Nlck1hbmFnZXIuaXRlbXMuc2xpY2UoKTsKKyAgICAgICAgbGV0IHByaXZhdGVQ
cm9wc0tleSA9IHRoaXMubG9hZGVyc1swXS5nbG9iYWxTY29wZS5QUklWQVRFX1BST1BTX0tFWTsK
ICAgICAgICAgdGhpcy5sb2FkZXJzWzBdLnVubG9hZCgpOwogCiAgICAgICAgIC8vIE1ha2Ugc3Vy
ZSB0aGUgYnJvd3NlciBtYW5hZ2VyIGlzIGNsZWFuZWQgdXAuCiAgICAgICAgIHRoaXMudGVzdC5h
c3NlcnRFcXVhbChicm93c2VyTWFuYWdlci53aW5kb3dzLmxlbmd0aCwgMCwKICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICJicm93c2VyTWFuYWdlciBzaG91bGQgaGF2ZSBubyB3aW5kb3dz
IGxlZnQiKTsKICAgICAgICAgdGhpcy50ZXN0LmFzc2VydEVxdWFsKGJyb3dzZXJNYW5hZ2VyLml0
ZW1zLmxlbmd0aCwgMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJicm93c2VyTWFu
YWdlciBzaG91bGQgaGF2ZSBubyBpdGVtcyBsZWZ0Iik7CiAKLSAgICAgICAgLy8gTWFrZSBzdXJl
IHRoZSBicm93c2VyIG1hbmFnZXIncyB3b3JrZXIgcmVnaXN0cnkgaXMgY2xlYW5lZCB1cC4KLSAg
ICAgICAgbGV0IG51bVdpbnMgPSAwOwotICAgICAgICBmb3IgKGxldCB3aW5LZXkgaW4gYnJvd3Nl
ck1hbmFnZXIud29ya2VyUmVnLndpbnMpCi0gICAgICAgICAgbnVtV2lucysrOwotICAgICAgICB0
aGlzLnRlc3QuYXNzZXJ0RXF1YWwobnVtV2lucywgMCwKLSAgICAgICAgICAiYnJvd3Nlck1hbmFn
ZXIgd29ya2VyIHJlZ2lzdHJ5IHNob3VsZCBoYXZlIG5vIHdpbmRvd3MgbGVmdCIpOwotCi0gICAg
ICAgIGxldCBudW1JdGVtTGlzdHMgPSAwOwotICAgICAgICBmb3IgZWFjaCAobGV0IGl0ZW1MaXN0
IGluIGJyb3dzZXJNYW5hZ2VyLndvcmtlclJlZy5pdGVtcykKLSAgICAgICAgICBudW1JdGVtTGlz
dHMrKzsKLSAgICAgICAgdGhpcy50ZXN0LmFzc2VydEVxdWFsKG51bUl0ZW1MaXN0cywgMCwKLSAg
ICAgICAgICAiYnJvd3Nlck1hbmFnZXIgd29ya2VyIHJlZ2lzdHJ5IHNob3VsZCBoYXZlIG5vIGl0
ZW0gbGlzdHMgbGVmdCIpOwotCi0gICAgICAgIGxldCBudW1NYXRyaXhSb3dzID0gMDsKLSAgICAg
ICAgZm9yICh3aW5LZXkgaW4gYnJvd3Nlck1hbmFnZXIud29ya2VyUmVnLndvcmtlcnMpCi0gICAg
ICAgICAgbnVtTWF0cml4Um93cysrOwotICAgICAgICB0aGlzLnRlc3QuYXNzZXJ0RXF1YWwobnVt
TWF0cml4Um93cywgMCwKLSAgICAgICAgICAiYnJvd3Nlck1hbmFnZXIgd29ya2VyIHJlZ2lzdHJ5
J3Mgd29ya2VyIG1hdHJpeCBzaG91bGQgYmUgZW1wdHkiKTsKKyAgICAgICAgLy8gTWFrZSBzdXJl
IHRoZSBpdGVtcycgd29ya2VyIHJlZ2lzdHJpZXMgYXJlIGNsZWFuZWQgdXAuCisgICAgICAgIGl0
ZW1zLmZvckVhY2goZnVuY3Rpb24gKGl0ZW0pIHsKKyAgICAgICAgICBsZXQgd29ya2VyUmVnID0g
aXRlbS52YWx1ZU9mKHByaXZhdGVQcm9wc0tleSkud29ya2VyUmVnOworICAgICAgICAgIHRoaXMu
dGVzdC5hc3NlcnRFcXVhbChPYmplY3Qua2V5cyh3b3JrZXJSZWcud2luV29ya2VycykubGVuZ3Ro
LCAwLAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAid29ya2VyIHJlZ2lzdHJ5IHNo
b3VsZCBiZSBlbXB0eSIpOworICAgICAgICAgIHRoaXMudGVzdC5hc3NlcnRFcXVhbCgKKyAgICAg
ICAgICAgIE9iamVjdC5rZXlzKHdvcmtlclJlZy53aW5zV2l0aG91dFdvcmtlcnMpLmxlbmd0aCwg
MCwKKyAgICAgICAgICAgICJ3b3JrZXIgcmVnaXN0cnkgbGlzdCBvZiB3aW5kb3dzIHdpdGhvdXQg
d29ya2VycyBzaG91bGQgYmUgZW1wdHkiKTsKKyAgICAgICAgfSwgdGhpcyk7CiAgICAgICB9CiAg
ICAgICB0aGlzLnRlc3QuZG9uZSgpOwogICAgIH0KIAogICAgIGZ1bmN0aW9uIGNsb3NlQnJvd3Nl
cldpbmRvdygpIHsKICAgICAgIGlmICh0aGlzLm9sZEJyb3dzZXJXaW5kb3cpIHsKICAgICAgICAg
dGhpcy5kZWxheWVkRXZlbnRMaXN0ZW5lcih0aGlzLmJyb3dzZXJXaW5kb3csICJ1bmxvYWQiLCBj
b21tb25Eb25lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhbHNlKTsK
</data>
<flag name="review"
          id="438193"
          type_id="4"
          status="+"
          setter="myk"
    />
          </attachment>
      

    </bug>

</bugzilla>